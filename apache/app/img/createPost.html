<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Vehículos</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>

    <h1>Agregar Vehículos</h1>

    <!-- Formulario para título y descripción de la flota -->
    <div id="fleetInfo">
        <h2>Información de la flota</h2>
        <input type="text" id="fleetTitle" placeholder="Título de la flota" required><br>
        <textarea id="fleetDescription" placeholder="Descripción de la flota" required></textarea><br>
        <button type="button" id="startAddingVehiclesBtn">Iniciar Agregar Vehículos</button>
    </div>

    <!-- Formulario para agregar vehículos -->
    <div id="vehicleFormSection" style="display: none;">
        <form id="vehicleForm">
            <input type="text" id="make" placeholder="Marca" required><br>
            <input type="text" id="model" placeholder="Modelo" required><br>
            <input type="number" id="year" placeholder="Año" required><br>
            <input type="number" id="price" placeholder="Precio" required><br>
            <textarea id="description" placeholder="Descripción" required></textarea><br>
            
            <!-- Desplegables de tipo de vehículo y combustible -->
            <select id="vehicleType" required>
                <option value="" disabled selected>Seleccionar Tipo de Vehículo</option>
                <option value="coche">Coche</option>
                <option value="camion">Camión</option>
            </select><br>

            <select id="fuelType" required>
                <option value="" disabled selected>Seleccionar Tipo de Combustible</option>
                <option value="diesel">Diésel</option>
                <option value="gasolina">Gasolina</option>
            </select><br>

            <!-- Permitir solo imágenes -->
            <input type="file" id="photos" multiple required accept="image/*"><br>
            <button type="button" id="addVehicleBtn">Añadir Vehículo</button>
        </form>
    </div>

    <div id="vehicleList"></div>

    <button type="button" id="uploadVehiclesBtn" style="display: none;">Subir Vehículos</button>

    <script>
        // Array para almacenar los vehículos
        let vehicles = [];
        let fleetInfo = {}; // Objeto para almacenar la información de la flota

        // Botón para iniciar el proceso de agregar vehículos
        document.getElementById('startAddingVehiclesBtn').addEventListener('click', function() {
            const fleetTitle = document.getElementById('fleetTitle').value;
            const fleetDescription = document.getElementById('fleetDescription').value;

            if (fleetTitle && fleetDescription) {
                // Almacenar la información de la flota
                fleetInfo = { title: fleetTitle, description: fleetDescription };

                // Ocultar el formulario de flota y mostrar el formulario de vehículos
                document.getElementById('fleetInfo').style.display = 'none';
                document.getElementById('vehicleFormSection').style.display = 'block';
                document.getElementById('uploadVehiclesBtn').style.display = 'inline-block'; // Mostrar botón para subir vehículos
            } else {
                alert("Por favor, ingrese un título y descripción para la flota.");
            }
        });

        // Botón para añadir vehículo
        document.getElementById('addVehicleBtn').addEventListener('click', function() {
            const make = document.getElementById('make').value;
            const model = document.getElementById('model').value;
            const year = document.getElementById('year').value;
            const price = document.getElementById('price').value;
            const description = document.getElementById('description').value;
            const vehicleType = document.getElementById('vehicleType').value;
            const fuelType = document.getElementById('fuelType').value;
            const photos = document.getElementById('photos').files;

            // Crear el objeto del vehículo
            const vehicleItem = {
                make,
                model,
                year,
                price,
                description,
                vehicleType,
                fuelType,
                photos: []
            };

            // Procesar las fotos
            const readerPromises = [];
            for (const element of photos) {
                const reader = new FileReader();
                readerPromises.push(new Promise((resolve, reject) => {
                    reader.onload = function(e) {
                        vehicleItem.photos.push(e.target.result);
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(element);
                }));
            }

            // Después de que todas las fotos se hayan cargado, agregar el vehículo a la flota
            Promise.all(readerPromises).then(() => {
                // Añadir el vehículo a la lista visual
                const vehicleList = document.getElementById('vehicleList');
                const vehicleDiv = document.createElement('div');
                vehicleDiv.classList.add('vehicle-item');

                let photoHTML = '';
                vehicleItem.photos.forEach(photo => {
                    photoHTML += `<img src="${photo}" alt="Foto del vehículo" style="width: 100px; margin: 5px;">`;
                });

                vehicleDiv.innerHTML = `
                    <h3>${vehicleItem.make} ${vehicleItem.model} (${vehicleItem.year})</h3>
                    <p>Precio: $${vehicleItem.price}</p>
                    <p>${vehicleItem.description}</p>
                    <p>Tipo de Vehículo: ${vehicleItem.vehicleType}</p>
                    <p>Combustible: ${vehicleItem.fuelType}</p>
                    <div>${photoHTML}</div>
                `;
                vehicleList.appendChild(vehicleDiv);

                // Añadir el vehículo al array de la flota
                vehicles.push(vehicleItem);

                // Limpiar el formulario
                document.getElementById('vehicleForm').reset();
            }).catch(err => {
                console.error('Error al cargar las fotos:', err);
            });
        });

        // Botón para subir todos los vehículos
        document.getElementById('uploadVehiclesBtn').addEventListener('click', function() {
            // Combinar la información de la flota con los vehículos
            const fleetData = {
                ...fleetInfo,
                vehicles: vehicles
            };

            // Simular el envío de datos (por ejemplo, a una API)
            console.log('Enviando la flota:', fleetData);

            // Aquí puedes hacer un POST real con fetch o axios
            /*
            fetch('/api/submitFleet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(fleetData),
            })
            .then(response => response.json())
            .then(data => {
                alert('Flota enviada con éxito');
            })
            .catch((error) => {
                console.error('Error al enviar la flota:', error);
            });
            */
        });
    </script>

</body>
</html>
